<!DOCTYPE html>
<html>
<head>
    <title>SmartFarm Auth Tester</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .endpoint { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 15px; margin: 5px 0; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>SmartFarm Auth Tester</h1>
    
    <div class="endpoint">
        <h2>1. Register</h2>
        <div>
            <button onclick="testRegister()">Test Register</button>
            <div id="registerResult" class="result"></div>
        </div>
    </div>

    <div class="endpoint">
        <h2>2. Login</h2>
        <div>
            <button onclick="testLogin()">Test Login</button>
            <div id="loginResult" class="result"></div>
        </div>
    </div>

    <div class="endpoint">
        <h2>3. Get Current User</h2>
        <div>
            <button onclick="testGetCurrentUser()">Get Current User</button>
            <div id="currentUserResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        let authTokens = {
            access: localStorage.getItem('accessToken'),
            refresh: localStorage.getItem('refreshToken')
        };

        function showResult(elementId, success, data) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = success ? 'result success' : 'result error';
            resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        async function makeRequest(method, endpoint, data = null, useAuth = false) {
            const config = {
                method,
                url: `${API_BASE_URL}${endpoint}`,
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (useAuth && authTokens.access) {
                config.headers['Authorization'] = `Bearer ${authTokens.access}`;
            }

            if (data) {
                config.data = JSON.stringify(data);
            }

            try {
                const response = await fetch(config.url, {
                    method: config.method,
                    headers: config.headers,
                    body: config.data,
                    credentials: 'include'
                });

                const responseData = await response.json().catch(() => ({}));
                
                if (!response.ok) {
                    return { error: responseData || 'Request failed', status: response.status };
                }

                return { data: responseData, status: response.status };
            } catch (error) {
                return { error: error.message, status: 0 };
            }
        }

        async function testRegister() {
            const testUser = {
                email: `testuser_${Date.now()}@example.com`,
                password1: 'TestPass123!',
                password2: 'TestPass123!',
                first_name: 'Test',
                last_name: 'User'
            };

            const result = await makeRequest('POST', '/auth/register/', testUser);
            showResult('registerResult', !result.error, result.error || result.data);
        }

        async function testLogin() {
            const credentials = {
                email: 'test@example.com', // Change to your test user's email
                password: 'testpass'       // Change to your test user's password
            };

            const result = await makeRequest('POST', '/auth/login/', credentials);
            
            if (result.data && result.data.access) {
                authTokens = {
                    access: result.data.access,
                    refresh: result.data.refresh
                };
                localStorage.setItem('accessToken', authTokens.access);
                localStorage.setItem('refreshToken', authTokens.refresh);
            }
            
            showResult('loginResult', !result.error, result.error || result.data);
        }

        async function testGetCurrentUser() {
            if (!authTokens.access) {
                showResult('currentUserResult', false, 'No access token available. Please login first.');
                return;
            }

            const result = await makeRequest('GET', '/auth/me/', null, true);
            showResult('currentUserResult', !result.error, result.error || result.data);
        }
    </script>
</body>
</html>
